import requests
import xml.etree.ElementTree as ET
import pandas as pd
from rapidfuzz import process, fuzz

MY_API_KEY_FOOD = "d96a60713f474e4596e6" #ì œê°€ ë°›ì€ í‚¤ì…ë‹ˆë‹¤.
url_food = "http://openapi.foodsafetykorea.go.kr/api/d96a60713f474e4596e6/COOKRCP01/xml/1/999"
#url_food += f"?ServiceKey={MY_API_KEY_FOOD}"

response = requests.get(url_food)

# ì •ìƒì ìœ¼ë¡œ ê°€ì ¸ì™”ëŠ”ì§€ í™•ì¸
if response.status_code == 200:
    # xml ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
    with open("output.xml", "wb") as f:   # "wb"ëŠ” ë°”ì´ë„ˆë¦¬ ëª¨ë“œ
        f.write(response.content)
    print("XML íŒŒì¼ ì €ì¥ ì™„ë£Œ: output.xml")
else:
    print("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ:", response.status_code)



root = ET.fromstring(response.content)   # XML íŒŒì‹±
print(root.tag, root.attrib)

data = []
for row in root.iter("row"):
    item = {
        "ë ˆì‹œí”¼ë²ˆí˜¸": row.find("RCP_SEQ").text,
        "ë ˆì‹œí”¼ëª…": row.find("RCP_NM").text,
        "ì¬ë£Œì •ë³´": row.find("RCP_PARTS_DTLS").text
    }
    data.append(item)

df = pd.DataFrame(data)

pd.set_option("display.max_rows", None)


pd.set_option("display.max_rows", None)
print(df["ë ˆì‹œí”¼ëª…"])


# ìœ ì € ì…ë ¥
food = str(input("ìŒì‹ëª… ì…ë ¥: "))
allergy = str(input("ì•Œë ˆë¥´ê¸° ì¬ë£Œ ì…ë ¥: "))

# ë™ì˜ì–´ ì‚¬ì „ (ì¶”ê°€ ê°€ëŠ¥)
allergy_dict = {
    "ìƒˆìš°": ["ìƒˆìš°", "ìƒˆìš°ì‚´", "ëŒ€ê²Œ", "ì¹µí…Œì¼ ìƒˆìš°"],
    "ê³„ë€": ["ê³„ë€", "ë‹¬ê±€", "ì—ê·¸"],
}

def fuzzy_search_rapidfuzz(df, query, topn=5):
    names = df["ë ˆì‹œí”¼ëª…"].astype(str).tolist()
    results = process.extract(query, names, scorer=fuzz.WRatio, limit=topn)
    out = [{"ë ˆì‹œí”¼ëª…": m[0], "ì ìˆ˜(0~100)": m[1]} for m in results]
    return pd.DataFrame(out)

# ê²€ìƒ‰
high_possible_result = fuzzy_search_rapidfuzz(df, food, topn=5)
print(high_possible_result)

if not high_possible_result.empty:
    recipe_name = high_possible_result.iloc[0]["ë ˆì‹œí”¼ëª…"]  # ê°€ì¥ ë†’ì€ í›„ë³´
    result_ing = df.loc[df["ë ˆì‹œí”¼ëª…"] == recipe_name, "ì¬ë£Œì •ë³´"]

    if not result_ing.empty:
        ingredients = result_ing.iloc[0].split(",")  # ì½¤ë§ˆ ê¸°ì¤€ ë¶„ë¦¬
        ingredients = [i.strip() for i in ingredients]

        print("ì¬ë£Œ ëª©ë¡:", ingredients)

        # ë™ì˜ì–´ í™•ì¥
        allergy_list = allergy_dict.get(allergy, [allergy])

        # ê²€ì‚¬
        found = False
        for ing in ingredients:
            if any(a in ing for a in allergy_list):
                print(f"âš ï¸ ì•Œë ˆë¥´ê¸° ì¬ë£Œ ë°œê²¬: {ing} â†’ ë¨¹ì§€ë§ˆì„¸ìš”!")
                found = True

        if not found:
            print("ì•ˆì „í•©ë‹ˆë‹¤ ğŸ‘")
    else:
        print("í•´ë‹¹ ë ˆì‹œí”¼ì— ì¬ë£Œì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    print("ìœ ì‚¬í•œ ë ˆì‹œí”¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
