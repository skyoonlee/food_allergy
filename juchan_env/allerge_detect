import requests
import xml.etree.ElementTree as ET
import pandas as pd
from rapidfuzz import process, fuzz

# âœ… ë¡œì»¬ XML íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
tree = ET.parse("api_xml.xml")  # ê°™ì€ í´ë” ì•ˆì— ìˆëŠ” recipes.xml
root = tree.getroot()


# row.find("RCP_SEQ").text -> row.findtext("RCP_SEQ") ë³€ê²½
# ë ˆì‹œí”¼ NM ì§€ìš´ ê³³ì—ì„œ None ê°’ ì¶œë ¥ ì˜¤ë¥˜ìˆ˜ì • (continue ë°©ì‹ë³´ë‹¤ text ì¶”ì¶œ ë°©ì‹ìœ¼ë¡œ ì§„í–‰)
data = []
for row in root.iter("row"):
    item = {
        "ë ˆì‹œí”¼ë²ˆí˜¸": row.findtext("RCP_SEQ"),
        "ë ˆì‹œí”¼ëª…": row.findtext("RCP_NM"),
        "ì¬ë£Œì •ë³´": row.findtext("RCP_PARTS_DTLS")
    }
    data.append(item)


df = pd.DataFrame(data)

pd.set_option("display.max_rows", None)

# ìœ ì € ì…ë ¥
food = str(input("ìŒì‹ëª… ì…ë ¥: "))
allergy = str(input("ì•Œë ˆë¥´ê¸° ì¬ë£Œ ì…ë ¥: "))

# ì•Œë ˆë¥´ê¸° ë™ì˜ì–´ ì‚¬ì „
allergy_dict = {
    "ê³„ë€": ["ê³„ë€", "ë‹¬ê±€", "ì—ê·¸", "ë‚œë°±", "ë‚œí™©", "egg"],
    "ìš°ìœ ": ["ìš°ìœ ", "ë°€í¬", "ë²„í„°", "ì¹˜ì¦ˆ", "ìš”ê±°íŠ¸", "ë¶„ìœ ", "milk"],
    "ë°€": ["ë°€", "ë°€ê°€ë£¨", "ì†Œë§¥", "wheat", "ê¸€ë£¨í…","í–„ë²„ê±°","ë¼ë©´","ë¹µ"],
    "ê°‘ê°ë¥˜": ["ìƒˆìš°", "ìƒˆìš°ì‚´", "ëŒ€í•˜", "ëŒ€ê²Œ", "ê½ƒê²Œ", "í‚¹í¬ë©", "ëìŠ¤í„°", "ê²Œ", "crab", "shrimp", "lobster"],
    "ìƒì„ ": ["ìƒì„ ", "ì–´ë¥˜", "ê³ ë“±ì–´", "ì—°ì–´", "ì°¸ì¹˜", "ì‚¼ì¹˜", "fish", "mackerel", "salmon", "tuna","ë¶ì–´","í™©íƒœ","ì•„ê·€"],
    "ë¼ì§€ê³ ê¸°": ["ë¼ì§€ê³ ê¸°", "ë¼ì§€", "ëˆìœ¡", "pork"],
    "ê²¬ê³¼ë¥˜": ["ë•…ì½©", "peanut","í˜¸ë‘", "walnut","ì½©", "ëŒ€ë‘", "ë‘ìœ ", "soybean", "soy","ì£"],
    "ì¡°ê°œ": ["ì¡°ê°œ", "í™í•©", "ë°”ì§€ë½", "êµ´", "ê°€ë¦¬ë¹„","ê´€ì", "clam", "mussel", "scallop", "oyster"],
    "ë³µìˆ­ì•„": ["ë³µìˆ­ì•„", "peach"],
    "ì½©": ["ì½©", "ëŒ€ë‘", "ë‘ìœ ", "soybean", "soy"],
    "ì‚¬ê³¼": ["ì‚¬ê³¼", "apple"],
    "ë‹­ê³ ê¸°": ["ë‹­ê³ ê¸°", "ë‹­", "ì¹˜í‚¨", "ê³„ìœ¡", "chicken"],
    "ë©”ë°€": ["ë©”ë°€", "buckwheat"],
    "ì‡ ê³ ê¸°": ["ì‡ ê³ ê¸°", "ì†Œê³ ê¸°", "ì†Œ", "beef"],
    "í‚¤ìœ„": ["í‚¤ìœ„", "kiwi"],
    "ì•„ëª¬ë“œ": ["ì•„ëª¬ë“œ", "almond"],
    "ë“¤ê¹¨": ["ë“¤ê¹¨", "perilla", "perilla seed"],
    "í† ë§ˆí† ": ["í† ë§ˆí† ", "tomato","ì¼€ì²©"],
    "ì˜¤ì§•ì–´": ["ì˜¤ì§•ì–´", "squid"],
    "í•´ì¡°ë¥˜": ["ë¯¸ì—­", "seaweedquid"],
    # í•„ìš”í•˜ë©´ ì¶”ê°€í•˜ì„¸ìš”
}

def fuzzy_search_rapidfuzz(df, query, topn=5):
    names = df["ë ˆì‹œí”¼ëª…"].astype(str).tolist()
    results = process.extract(query, names, scorer=fuzz.WRatio, limit=topn)
    out = [{"ë ˆì‹œí”¼ëª…": m[0], "ì ìˆ˜(0~100)": m[1]} for m in results]
    return pd.DataFrame(out)

# ë ˆì‹œí”¼ ê²€ìƒ‰
high_possible_result = fuzzy_search_rapidfuzz(df, food, topn=5)
print(high_possible_result)

if not high_possible_result.empty:
    recipe_name = high_possible_result.iloc[0]["ë ˆì‹œí”¼ëª…"]  # ê°€ì¥ ë†’ì€ í›„ë³´
    result_ing = df.loc[df["ë ˆì‹œí”¼ëª…"] == recipe_name, "ì¬ë£Œì •ë³´"]

    if not result_ing.empty:
        # ì½¤ë§ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë¦¬ìŠ¤íŠ¸í™”
        # replaceë¡œ ì¤„ë°”ê¿ˆ \n í‘œê¸° ì‚­ì œ
        ingredients = [i.strip() for i in result_ing.iloc[0].replace("\n"," ").split(",")]
        print("ì¬ë£Œ ëª©ë¡:", ingredients)

        # ì•Œë ˆë¥´ê¸° ë™ì˜ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        allergy_list = allergy_dict.get(allergy, [allergy])

        # ê²€ì‚¬
        found = [ing for ing in ingredients if any(a in ing for a in allergy_list)]

        if found:
            print(f"âš ï¸ ì•Œë ˆë¥´ê¸° ì¬ë£Œ ë°œê²¬: {found} â†’ ë¨¹ì§€ë§ˆì„¸ìš”!")
        else:
            print("ì•ˆì „í•©ë‹ˆë‹¤ ğŸ‘")
    else:
        print("í•´ë‹¹ ë ˆì‹œí”¼ì— ì¬ë£Œì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    print("ìœ ì‚¬í•œ ë ˆì‹œí”¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
