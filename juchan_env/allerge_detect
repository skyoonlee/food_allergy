import requests
import xml.etree.ElementTree as ET
import pandas as pd
from rapidfuzz import process, fuzz

MY_API_KEY_FOOD = "d96a60713f474e4596e6" #제가 받은 키입니다.
url_food = "http://openapi.foodsafetykorea.go.kr/api/d96a60713f474e4596e6/COOKRCP01/xml/1/999"
#url_food += f"?ServiceKey={MY_API_KEY_FOOD}"

response = requests.get(url_food)

# 정상적으로 가져왔는지 확인
if response.status_code == 200:
    # xml 내용을 파일로 저장
    with open("output.xml", "wb") as f:   # "wb"는 바이너리 모드
        f.write(response.content)
    print("XML 파일 저장 완료: output.xml")
else:
    print("데이터를 가져오지 못했습니다. 상태 코드:", response.status_code)



root = ET.fromstring(response.content)   # XML 파싱
print(root.tag, root.attrib)

data = []
for row in root.iter("row"):
    item = {
        "레시피번호": row.find("RCP_SEQ").text,
        "레시피명": row.find("RCP_NM").text,
        "재료정보": row.find("RCP_PARTS_DTLS").text
    }
    data.append(item)

df = pd.DataFrame(data)

pd.set_option("display.max_rows", None)


pd.set_option("display.max_rows", None)
print(df["레시피명"])


# 유저 입력
food = str(input("음식명 입력: "))
allergy = str(input("알레르기 재료 입력: "))

# 알레르기 동의어 사전
allergy_dict = {
    "계란": ["계란", "달걀", "에그", "난백", "난황", "egg"],
    "우유": ["우유", "밀크", "버터", "치즈", "요거트", "분유", "milk"],
    "밀": ["밀", "밀가루", "소맥", "wheat", "글루텐","햄버거","라면","빵"],
    "갑각류": ["새우", "새우살", "대하", "대게", "꽃게", "킹크랩", "랍스터", "게", "crab", "shrimp", "lobster"],
    "생선": ["생선", "어류", "고등어", "연어", "참치", "삼치", "fish", "mackerel", "salmon", "tuna"],
    "돼지고기": ["돼지고기", "돼지", "돈육", "pork"],
    "견과류": ["땅콩", "peanut","호두", "walnut","콩", "대두", "두유", "soybean", "soy","잣"],
    "조개": ["조개", "홍합", "바지락", "굴", "가리비", "clam", "mussel", "scallop", "oyster"],
    "복숭아": ["복숭아", "peach"],
    "콩": ["콩", "대두", "두유", "soybean", "soy"],
    "사과": ["사과", "apple"],
    "닭고기": ["닭고기", "닭", "치킨", "계육", "chicken"],
    "메밀": ["메밀", "buckwheat"],
    "쇠고기": ["쇠고기", "소고기", "소", "beef"],
    "키위": ["키위", "kiwi"],
    "아몬드": ["아몬드", "almond"],
    "들깨": ["들깨", "perilla", "perilla seed"],
    "토마토": ["토마토", "tomato","케첩"],
    "오징어": ["오징어", "squid"],
    # 필요하면 추가하세요
}

def fuzzy_search_rapidfuzz(df, query, topn=5):
    names = df["레시피명"].astype(str).tolist()
    results = process.extract(query, names, scorer=fuzz.WRatio, limit=topn)
    out = [{"레시피명": m[0], "점수(0~100)": m[1]} for m in results]
    return pd.DataFrame(out)

# 레시피 검색
high_possible_result = fuzzy_search_rapidfuzz(df, food, topn=5)
print(high_possible_result)

if not high_possible_result.empty:
    recipe_name = high_possible_result.iloc[0]["레시피명"]  # 가장 높은 후보
    result_ing = df.loc[df["레시피명"] == recipe_name, "재료정보"]

    if not result_ing.empty:
        # 콤마 기준으로 나눠서 리스트화
        ingredients = [i.strip() for i in result_ing.iloc[0].split(",")]
        print("재료 목록:", ingredients)

        # 알레르기 동의어 목록 가져오기
        allergy_list = allergy_dict.get(allergy, [allergy])

        # 검사
        found = [ing for ing in ingredients if any(a in ing for a in allergy_list)]

        if found:
            print(f"⚠️ 알레르기 재료 발견: {found} → 먹지마세요!")
        else:
            print("안전합니다 👍")
    else:
        print("해당 레시피에 재료정보가 없습니다.")
else:
    print("유사한 레시피를 찾지 못했습니다.")

