import requests
import xml.etree.ElementTree as ET
import pandas as pd
from rapidfuzz import process, fuzz

MY_API_KEY_FOOD = "d96a60713f474e4596e6" #ì œê°€ ë°›ì€ í‚¤ì…ë‹ˆë‹¤.
url_food = "http://openapi.foodsafetykorea.go.kr/api/d96a60713f474e4596e6/COOKRCP01/xml/1/999"
#url_food += f"?ServiceKey={MY_API_KEY_FOOD}"

response = requests.get(url_food)

# ì •ìƒì ìœ¼ë¡œ ê°€ì ¸ì™”ëŠ”ì§€ í™•ì¸
if response.status_code == 200:
    # xml ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
    with open("output.xml", "wb") as f:   # "wb"ëŠ” ë°”ì´ë„ˆë¦¬ ëª¨ë“œ
        f.write(response.content)
    print("XML íŒŒì¼ ì €ì¥ ì™„ë£Œ: output.xml")
else:
    print("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ:", response.status_code)



root = ET.fromstring(response.content)   # XML íŒŒì‹±
print(root.tag, root.attrib)

data = []
for row in root.iter("row"):
    item = {
        "ë ˆì‹œí”¼ë²ˆí˜¸": row.find("RCP_SEQ").text,
        "ë ˆì‹œí”¼ëª…": row.find("RCP_NM").text,
        "ì¬ë£Œì •ë³´": row.find("RCP_PARTS_DTLS").text
    }
    data.append(item)

df = pd.DataFrame(data)

pd.set_option("display.max_rows", None)


pd.set_option("display.max_rows", None)
print(df["ë ˆì‹œí”¼ëª…"])


# ìœ ì € ì…ë ¥
food = str(input("ìŒì‹ëª… ì…ë ¥: "))
allergy = str(input("ì•Œë ˆë¥´ê¸° ì¬ë£Œ ì…ë ¥: "))

# ì•Œë ˆë¥´ê¸° ë™ì˜ì–´ ì‚¬ì „
allergy_dict = {
    "ê³„ë€": ["ê³„ë€", "ë‹¬ê±€", "ì—ê·¸", "ë‚œë°±", "ë‚œí™©", "egg"],
    "ìš°ìœ ": ["ìš°ìœ ", "ë°€í¬", "ë²„í„°", "ì¹˜ì¦ˆ", "ìš”ê±°íŠ¸", "ë¶„ìœ ", "milk"],
    "ë°€": ["ë°€", "ë°€ê°€ë£¨", "ì†Œë§¥", "wheat", "ê¸€ë£¨í…","í–„ë²„ê±°","ë¼ë©´","ë¹µ"],
    "ê°‘ê°ë¥˜": ["ìƒˆìš°", "ìƒˆìš°ì‚´", "ëŒ€í•˜", "ëŒ€ê²Œ", "ê½ƒê²Œ", "í‚¹í¬ë©", "ëìŠ¤í„°", "ê²Œ", "crab", "shrimp", "lobster"],
    "ìƒì„ ": ["ìƒì„ ", "ì–´ë¥˜", "ê³ ë“±ì–´", "ì—°ì–´", "ì°¸ì¹˜", "ì‚¼ì¹˜", "fish", "mackerel", "salmon", "tuna"],
    "ë¼ì§€ê³ ê¸°": ["ë¼ì§€ê³ ê¸°", "ë¼ì§€", "ëˆìœ¡", "pork"],
    "ê²¬ê³¼ë¥˜": ["ë•…ì½©", "peanut","í˜¸ë‘", "walnut","ì½©", "ëŒ€ë‘", "ë‘ìœ ", "soybean", "soy","ì£"],
    "ì¡°ê°œ": ["ì¡°ê°œ", "í™í•©", "ë°”ì§€ë½", "êµ´", "ê°€ë¦¬ë¹„", "clam", "mussel", "scallop", "oyster"],
    "ë³µìˆ­ì•„": ["ë³µìˆ­ì•„", "peach"],
    "ì½©": ["ì½©", "ëŒ€ë‘", "ë‘ìœ ", "soybean", "soy"],
    "ì‚¬ê³¼": ["ì‚¬ê³¼", "apple"],
    "ë‹­ê³ ê¸°": ["ë‹­ê³ ê¸°", "ë‹­", "ì¹˜í‚¨", "ê³„ìœ¡", "chicken"],
    "ë©”ë°€": ["ë©”ë°€", "buckwheat"],
    "ì‡ ê³ ê¸°": ["ì‡ ê³ ê¸°", "ì†Œê³ ê¸°", "ì†Œ", "beef"],
    "í‚¤ìœ„": ["í‚¤ìœ„", "kiwi"],
    "ì•„ëª¬ë“œ": ["ì•„ëª¬ë“œ", "almond"],
    "ë“¤ê¹¨": ["ë“¤ê¹¨", "perilla", "perilla seed"],
    "í† ë§ˆí† ": ["í† ë§ˆí† ", "tomato","ì¼€ì²©"],
    "ì˜¤ì§•ì–´": ["ì˜¤ì§•ì–´", "squid"],
    # í•„ìš”í•˜ë©´ ì¶”ê°€í•˜ì„¸ìš”
}

def fuzzy_search_rapidfuzz(df, query, topn=5):
    names = df["ë ˆì‹œí”¼ëª…"].astype(str).tolist()
    results = process.extract(query, names, scorer=fuzz.WRatio, limit=topn)
    out = [{"ë ˆì‹œí”¼ëª…": m[0], "ì ìˆ˜(0~100)": m[1]} for m in results]
    return pd.DataFrame(out)

# ë ˆì‹œí”¼ ê²€ìƒ‰
high_possible_result = fuzzy_search_rapidfuzz(df, food, topn=5)
print(high_possible_result)

if not high_possible_result.empty:
    recipe_name = high_possible_result.iloc[0]["ë ˆì‹œí”¼ëª…"]  # ê°€ì¥ ë†’ì€ í›„ë³´
    result_ing = df.loc[df["ë ˆì‹œí”¼ëª…"] == recipe_name, "ì¬ë£Œì •ë³´"]

    if not result_ing.empty:
        # ì½¤ë§ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë¦¬ìŠ¤íŠ¸í™”
        ingredients = [i.strip() for i in result_ing.iloc[0].split(",")]
        print("ì¬ë£Œ ëª©ë¡:", ingredients)

        # ì•Œë ˆë¥´ê¸° ë™ì˜ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        allergy_list = allergy_dict.get(allergy, [allergy])

        # ê²€ì‚¬
        found = [ing for ing in ingredients if any(a in ing for a in allergy_list)]

        if found:
            print(f"âš ï¸ ì•Œë ˆë¥´ê¸° ì¬ë£Œ ë°œê²¬: {found} â†’ ë¨¹ì§€ë§ˆì„¸ìš”!")
        else:
            print("ì•ˆì „í•©ë‹ˆë‹¤ ğŸ‘")
    else:
        print("í•´ë‹¹ ë ˆì‹œí”¼ì— ì¬ë£Œì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    print("ìœ ì‚¬í•œ ë ˆì‹œí”¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

